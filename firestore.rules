rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isPublicRoom(roomId) {
      // Use exists() to check if document exists and get the isPublic field
      return exists(/databases/$(database)/documents/story_rooms/$(roomId)) &&
             get(/databases/$(database)/documents/story_rooms/$(roomId)).data.isPublic == true;
    }

    // Story rooms collection
    match /story_rooms/{roomId} {
      // Allow read access to public rooms or if signed in (for development)
      allow get, list: if (resource.data.isPublic == true || !exists(resource.data)) ||
                       (isSignedIn() && request.auth != null);

      // Create allowed for signed-in users (including anonymous)
      allow create: if isSignedIn() &&
        request.resource.data.keys().hasOnly([
          'title','description','creatorNickname','creatorUserId',
          'createdAt','lastUpdatedAt','participants','isPublic',
          'coverImageUrl','totalSentences','storyStarter'
        ]) &&
        request.resource.data.title is string && request.resource.data.title.size() > 0 &&
        request.resource.data.description is string &&
        request.resource.data.creatorNickname is string && request.resource.data.creatorNickname.size() > 0 &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.lastUpdatedAt is timestamp &&
        request.resource.data.participants is list &&
        request.resource.data.isPublic == true &&
        (request.resource.data.totalSentences is int || request.resource.data.totalSentences == null);

      // Allow updates for signed-in users (for development)
      allow update: if isSignedIn() &&
        request.resource.data.keys().hasOnly([
          'title','description','creatorNickname','creatorUserId',
          'createdAt','lastUpdatedAt','participants','isPublic',
          'coverImageUrl','totalSentences','storyStarter'
        ]);

      // Allow deletes for signed-in users (for development)
      allow delete: if isSignedIn();
    }

    // Story sentences collection
    match /story_sentences/{sentenceId} {
      // Read allowed if the sentence's room is public or if signed in (for development)
      allow get, list: if isPublicRoom(resource.data.roomId) ||
                       (isSignedIn() && request.auth != null);

      // Create allowed for signed-in users
      allow create: if isSignedIn() &&
        request.resource.data.keys().hasOnly([
          'roomId','content','authorNickname','authorUserId',
          'createdAt','order'
        ]) &&
        request.resource.data.roomId is string &&
        request.resource.data.content is string && request.resource.data.content.size() > 0 &&
        request.resource.data.authorNickname is string && request.resource.data.authorNickname.size() > 0 &&
        request.resource.data.createdAt is timestamp &&
        (request.resource.data.order is int || request.resource.data.order is number);

      // Allow updates for signed-in users (for development)
      allow update: if isSignedIn();

      // Allow deletes for signed-in users (for development)
      allow delete: if isSignedIn();
    }
  }
}
